name: Build & Deploy Servlet App  # ğŸ“› TÃªn workflow sáº½ hiá»ƒn thá»‹ trÃªn GitHub Actions UI

on:
  push:
    branches: [ "main" ]  # ğŸš€ Workflow Ä‘Æ°á»£c kÃ­ch hoáº¡t khi cÃ³ push lÃªn nhÃ¡nh "main"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest  # ğŸ’» Cháº¡y job trÃªn mÃ¡y áº£o Ubuntu má»›i nháº¥t do GitHub cung cáº¥p

    steps:
      - name: Clone source
        uses: actions/checkout@v3  # âœ… BÆ°á»›c 1: Checkout code tá»« repo GitHub vá» mÃ¡y runner

      - name: Setup Java 8
        uses: actions/setup-java@v3
        with:
          java-version: '8'  # ğŸ”§ CÃ i Ä‘Ãºng phiÃªn báº£n Java 8 phÃ¹ há»£p cho app Servlet
          distribution: 'temurin'  # ğŸ“¦ Sá»­ dá»¥ng báº£n Temurin (OpenJDK phá»• biáº¿n, á»•n Ä‘á»‹nh)

      - name: Build WAR with Maven
        run: mvn clean package  # ğŸ› ï¸ BÆ°á»›c 2: DÃ¹ng Maven Ä‘á»ƒ build project vÃ  táº¡o file WAR trong thÆ° má»¥c target/

      - name: Deploy WAR to Remote Tomcat
        uses: appleboy/scp-action@v0.1.3
        with:
          host: 192.168.1.8  # ğŸ” Biáº¿n mÃ´i trÆ°á»ng chá»©a Ä‘á»‹a chá»‰ IP hoáº·c domain cá»§a server (khai bÃ¡o trong Repository Secrets)
          username: hoangdv  # ğŸ‘¤ TÃ i khoáº£n SSH káº¿t ná»‘i vÃ o server
          password: 123456@Ab  # ğŸ”’ Máº­t kháº©u SSH (nÃªn dÃ¹ng SSH key cho an toÃ n hÆ¡n)
          port: 22
          source: target/servlet-ecm-app.war  # ğŸ“¦ ÄÆ°á»ng dáº«n Ä‘áº¿n file WAR Ä‘Ã£ build
          target: /home/hoangdv/  # ğŸ“‚ ThÆ° má»¥c deploy trÃªn server (Tomcat sáº½ tá»± load file WAR trong Ä‘Ã¢y náº¿u autoDeploy Ä‘Æ°á»£c báº­t)
          timeout: 300s  # TÄƒng timeout tá»« máº·c Ä‘á»‹nh
          command_timeout: 10m
          use_insecure_cipher: false
          rm: false
          debug: true  # Báº­t debug Ä‘á»ƒ xem log chi tiáº¿t